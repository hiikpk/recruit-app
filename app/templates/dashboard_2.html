{% extends 'layout.html' %}

{% block content %}
<div class="container">
  <h2>ダッシュボード② — 歩留まりと応募者分布</h2>

  <style>
    /* constrain pie canvas size and make grid */
  .pie-card canvas { max-height: 320px; width: 100% !important; }
  /* ensure cards don't make canvas larger than container */
  .pie-card .card-body { display:flex; align-items:center; justify-content:center; height:340px; }
  /* grid layout for pies: 2 columns on desktop, 1 column on small screens */
  .pie-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
  @media (max-width: 800px) { .pie-grid { grid-template-columns: 1fr; } }
    /* Filters: horizontal scroll on small screens, inline on large */
    .filters-row { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin-bottom:12px; }
    .filter-item { display:flex; flex-direction:column; min-width:140px; }
    @media (min-width: 992px) {
      .filter-item { min-width:160px; }
    }
  </style>

  <form method="get" class="mb-3">
    <div class="filters-row">
      <div class="filter-item">
        <label class="form-label">開始</label>
        <input type="date" name="start" class="form-control" value="{{ selected.start }}" />
      </div>
      <div class="filter-item">
        <label class="form-label">終了</label>
        <input type="date" name="end" class="form-control" value="{{ selected.end }}" />
      </div>
      <div class="filter-item">
        <label class="form-label">流入経路</label>
        <select name="channel" class="form-select">
          <option value="">すべて</option>
          {% for c in options.channels %}
          <option value="{{ c }}" {% if c in selected.channels %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-item">
        <label class="form-label">ポジション</label>
        <select name="position" class="form-select">
          <option value="">すべて</option>
          {% for p in options.positions %}
          <option value="{{ p }}" {% if p in selected.positions %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-item">
        <label class="form-label">年代</label>
        <select name="decade" class="form-select">
          <option value="">すべて</option>
          {% for d in options.decades %}
          <option value="{{ d }}" {% if d in selected.decades %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-item">
        <label class="form-label">男女</label>
        <select name="gender" class="form-select">
          <option value="">すべて</option>
          {% for g in options.genders %}
          <option value="{{ g }}" {% if g in selected.genders %}selected{% endif %}>{{ g }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-item" style="align-items:flex-start">
        <button class="btn btn-primary">適用</button>
      </div>
    </div>
  </form>

  <div class="card">
    <div class="card-body">
      <canvas id="yieldChart" height="120"></canvas>
    </div>
  </div>

  <div class="pie-grid mt-4">
    <div>
      <div class="card mb-3 pie-card">
        <div class="card-body">
          <h5>流入経路</h5>
          <canvas id="channelPie" style="max-width:420px; max-height:320px;"></canvas>
        </div>
      </div>
    </div>
    <div>
      <div class="card mb-3 pie-card">
        <div class="card-body">
          <h5>選考ポジション</h5>
          <canvas id="positionPie" style="max-width:420px; max-height:320px;"></canvas>
        </div>
      </div>
    </div>
    <div>
      <div class="card mb-3 pie-card">
        <div class="card-body">
          <h5>年代別</h5>
          <canvas id="decadePie" style="max-width:420px; max-height:320px;"></canvas>
        </div>
      </div>
    </div>
    <div>
      <div class="card mb-3 pie-card">
        <div class="card-body">
          <h5>男女別</h5>
          <canvas id="genderPie" style="max-width:420px; max-height:320px;"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const charts = {{ charts|tojson|safe }};

  // yield (bar chart)
  const yCtx = document.getElementById('yieldChart').getContext('2d');
  new Chart(yCtx, {
    type: 'bar',
    data: {
      labels: charts.yield.labels,
      datasets: [{
        label: '人数',
        data: charts.yield.values,
        backgroundColor: 'rgba(54, 162, 235, 0.6)'
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });

  function randomPalette(n){
    const pal = [];
    for(let i=0;i<n;i++) pal.push(`hsl(${(i*47)%360} 70% 50%)`);
    return pal;
  }

  // channel pie
  const channelCtx = document.getElementById('channelPie').getContext('2d');
  new Chart(channelCtx, {
    type: 'pie',
    data: { labels: charts.channels.labels, datasets: [{ data: charts.channels.values, backgroundColor: randomPalette(charts.channels.labels.length) }] }
  });

  // position pie
  const posCtx = document.getElementById('positionPie').getContext('2d');
  new Chart(posCtx, {
    type: 'pie',
    data: { labels: charts.positions.labels, datasets: [{ data: charts.positions.values, backgroundColor: randomPalette(charts.positions.labels.length) }] }
  });

  // decade pie
  const decCtx = document.getElementById('decadePie').getContext('2d');
  new Chart(decCtx, {
    type: 'pie',
    data: { labels: charts.decades.labels, datasets: [{ data: charts.decades.values, backgroundColor: randomPalette(charts.decades.labels.length) }] }
  });

  // gender pie
  const gCtx = document.getElementById('genderPie').getContext('2d');
  new Chart(gCtx, {
    type: 'pie',
    data: { labels: charts.genders.labels, datasets: [{ data: charts.genders.values, backgroundColor: randomPalette(charts.genders.labels.length) }] }
  });
</script>
{% endblock %}
