{% extends "layout.html" %}
{% block title %}面接{% endblock %}
{% block breadcrumbs %}{% if form and not interview %}選考 / <strong>新規作成</strong>{% else %}選考 / <strong>詳細</strong>{% endif %}{% endblock %}
{% block content %}
{% if form %}
<section class="card">
  <h3 class="card-title">{% if interview %}選考情報を編集{% else %}選考情報を新規作成{% endif %}</h3>
  <form method="post" enctype="multipart/form-data">
    {{ form.csrf_token }}
    <div class="grid2">
      <label class="label">候補者ID {{ form.candidate_id(class_="input") }}</label>
  <label class="label">選考ステップ {{ form.step(class_="select") }}</label>
  <label class="label">日時 {{ form.scheduled_at(class_="input") }}</label>
      <label class="label">状態 {{ form.status(class_="input") }}</label>
      <!-- <label class="label">場所 {{ form.location(class_="input") }}</label> -->
      <!-- <label class="label">URL {{ form.meeting_url(class_="input") }}</label> -->
      <label class="label">合否 {{ form.result(class_="select") }}</label>
      <label class="label">選考実施担当者 {{ form.interviewer(class_="input") }}</label>
    </div>
    {% if form.rank is defined %}
    <label class="label">ランク {{ form.rank(class_="select") }}</label>
    {% endif %}
    <div class="grid1" style="margin-top:10px">
      <label class="label">評価コメント {{ form.comment(class_="textarea", placeholder="所感・評価ポイントなど") }}</label>
      <label class="label">録音ファイル {{ form.file() }}</label>
    </div>
    <div class="grid1" style="margin-top:10px">
      <label class="label">文字起こし全文（編集可） {{ form.transcript_text(class_="textarea", placeholder="文字起こし全文を編集できます") }}</label>
    </div>
    <div class="form-actions">
      <button class="btn-primary" type="submit">{% if interview %}保存{% else %}作成{% endif %}</button>
      {% if interview %}
      <a class="btn-ghost" href="{{ url_for('interviews.detail', interview_id=interview.id) }}">キャンセル</a>
      {% else %}
      <a class="btn-ghost" href="{{ url_for('interviews.list_interviews') }}">キャンセル</a>
      {% endif %}
    </div>
  </form>
</section>

{% endif %}

{# If interview exists, show its details and AI evaluations below the form (or alone if no form) #}
{% if interview %}
<!-- <section class="card">
  <h3 class="card-title">面接詳細 #{{ interview.id }}</h3>
  <a class="btn-ghost" href="{{ url_for('interviews.download_ics', interview_id=interview.id) }}">ICSダウンロード</a>
  <div style="margin-top:12px">
    <p><strong>選考情報</strong></p>
    <div class="kv">
      <div><span>日時</span><p>{{ interview.scheduled_at.strftime('%Y-%m-%d %H:%M') if interview.scheduled_at else '-' }}</p></div>
      <div><span>ステップ</span><p>{{ interview.step or '-' }}</p></div>
      <div><span>状態</span><p>{{ interview.status or '-' }}</p></div>
      <div><span>合否</span><p>{{ interview.result or '-' }}</p></div>
    </div>
    <div style="margin-top:10px">
      <a class="btn-primary" href="{{ url_for('interviews.detail', interview_id=interview.id) }}">編集</a>
      <a class="btn-ghost" href="{{ url_for('interviews.list_interviews') }}">一覧へ戻る</a>
    </div>
  </div>
</section> -->
<section class="card" style="margin-top:12px">
  <h3 class="card-title">AI評価</h3>
  {% if evaluations and evaluations|length > 0 %}
    {% for ev in evaluations %}
    <div class="card" style="margin-bottom:8px">
      <div class="kv">
        <div><span>評価日時</span><p>{{ ev.created_at.strftime('%Y-%m-%d %H:%M') if ev.created_at else '-' }}</p></div>
        <div><span>総合スコア</span><p>{{ ("%0.2f"%ev.overall_score) if ev.overall_score is not none else '-' }}</p></div>
      </div>
      <div class="kv">
        <div><span>話し方</span><p>{{ ("%0.2f"%ev.speaking) if ev.speaking is not none else '-' }}</p></div>
        <div><span>ロジカル</span><p>{{ ("%0.2f"%ev.logical) if ev.logical is not none else '-' }}</p></div>
        <div><span>ボリューム</span><p>{{ ("%0.2f"%ev.volume) if ev.volume is not none else '-' }}</p></div>
        <div><span>誠実性</span><p>{{ ("%0.2f"%ev.honesty) if ev.honesty is not none else '-' }}</p></div>
        <div><span>主体性</span><p>{{ ("%0.2f"%ev.proactive) if ev.proactive is not none else '-' }}</p></div>
      </div>
      <div style="margin-top:8px">
        <strong>要約</strong>
        <p>{{ ev.gpt_summary or '-' }}</p>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <p>評価はまだありません。録音をアップロードして解析を実行してください。</p>
  {% endif %}
</section>
  {% if metrics %}
  <section class="card" style="margin-top:12px">
    <h3 class="card-title">話し方メトリクス</h3>
    <div class="kv">
      <div><span>合計発話時間 (s)</span><p>{{ metrics.total_time_sec or '-' }}</p></div>
      <div><span>平均沈黙時間 (s)</span><p>{{ metrics.avg_silence_sec or '-' }}</p></div>
      <div><span>沈黙回数</span><p>{{ metrics.silence_count or '-' }}</p></div>
      <div><span>割り込み回数</span><p>{{ metrics.interruptions or '-' }}</p></div>
      <div><span>フィラー率</span><p>{{ (metrics.filler_rate * 100)|round(2) ~ '%' if metrics.filler_rate is not none else '-' }}</p></div>
    </div>
    <div style="margin-top:8px">
      <strong>話者別詳細</strong>
      {% for spk, s in metrics.speakers.items() if metrics.speakers is defined %}
      <div class="card" style="margin-top:6px;padding:8px">
        <div class="kv">
          <div><span>話者</span><p>{{ spk }}</p></div>
          <div><span>発話時間 (s)</span><p>{{ s.total_sec }}</p></div>
          <div><span>発話割合</span><p>{{ (s.ratio * 100)|round(2) ~ '%' }}</p></div>
          <div><span>平均ターン長 (s)</span><p>{{ s.avg_turn_sec }}</p></div>
          <div><span>CPM</span><p>{{ s.cpm }}</p></div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}
  {% if interview.transcript_text %}
  <section class="card" style="margin-top:12px">
    <div style="display:flex; align-items:center; justify-content:space-between">
      <h3 class="card-title" style="margin:0">文字起こし全文</h3>
      <div>
        <button id="transcript-toggle-btn" class="btn-ghost" type="button">全文を表示</button>
        <button id="transcript-copy-btn" class="btn-ghost" type="button">全文コピー</button>
      </div>
    </div>
    <div id="transcript-body" class="transcript-body collapsed" style="white-space:pre-wrap; padding:8px; border:1px solid #eee; background:#fafafa">{{ interview.transcript_text }}</div>
  </section>
  {% endif %}
{% endif %}
{% endblock %}